# Kali Firmware Manual v2.0

<<<<<<< Updated upstream
Kali is a powerful delay and modulation instrument built for the Daisy platform. The v2.0 firmware keeps the deep feature set while adding a smoother on-ramp and a desktop OLED page renderer so you can study the interface before ever touching the hardware.
=======
---

**⚠️ QUICK HELP: Factory Reset**  
If Kali is behaving strangely on startup or won't boot properly:
1. Power off completely
2. Hold **both Gate Input buttons** (Gate In 1 + Gate In 2)
3. Power on while holding both buttons
4. Wait for "FACTORY RESET" message on screen
5. Release buttons

This restores all default settings. See [Factory Reset](#factory-reset) section for details.

---

## Overview
>>>>>>> Stashed changes

## How to use this manual
- **Start here.** The first sections are written as a guided tour to get sound moving immediately.
- **Grow with recipes.** Use the setup recipes to see how Kali fits into different rigs.
- **Check the reference last.** The final section is a full parameter reference for quick lookup once you are comfortable.

## What’s new in v2.0
- **OLED page renderer.** Use the built-in display code to capture every page as PNGs for tutorials, docs, or sharing presets without sitting in front of the module.
- **Refreshed onboarding.** Quick-start flow, setup recipes, and navigation cheats make the deep feature set approachable.
- **Documentation tuned for clarity.** Tables and parameter notes are consolidated in the Reference Library at the end.

---

## Your first 10 minutes
1. **Patch audio.** Connect stereo input/output. If using mono, start with the left input/output.
2. **Choose a voice.** Turn the left encoder to `DSP EDIT` and pick a delay Mode that fits the source (basic delay to start).
3. **Set the mix.** Use the Mix knob for a 50/50 balance, then bring up Feedback until repeats feel right.
4. **Lock the tempo.** Go to `OPTIONS` → `Sync Mode`. Start on **Internal**; if you have clock, choose **External CV** or **MIDI**.
5. **Animate with an LFO.** From `LFO EDIT`, select LFO 1 and set **Waveform** to Sine. Assign **AM Target** to `Delay Time L` (via the modulation routing) and set **Attenuate** around 40% for gentle movement.
6. **Save it.** Hold both encoders to write the state so you can revisit this baseline patch.

If something sounds wrong, check **Input Gain** and **Output Gain** on the `OPTIONS` page; 215/255 is unity for most setups.

---

## Setup recipes
### Pedalboard or desktop synth
- Clock: leave on **Internal** or feed a click into **Gate 1** with **Sync Mode → External CV**.
- Modulation: assign LFOs 1–2 to delay times for chorus-like motion; keep **Attenuate** low (under 30%) to avoid seasick repeats.
- Freeze: set **Freeze Button Mode → Freeze Delay** so Gate 2 becomes an instant looper during solos.

### DAW + MIDI controller
- Connect MIDI in/out and set **Sync Mode → MIDI Clock**.
- Map a fader/knob to **Mix** or **Feedback** via MIDI CC for hands-on automation.
- Use the OLED page renderer captures alongside your DAW so you can line up grid divisions with the on-screen clock readout.

### Modular rack
- Keep **Input Width → Mono** if feeding a single oscillator; switch to **Stereo** for dual voices.
- Set **Left Clock PPQN** to match your master clock (4 = quarter notes, 24 = MIDI standard). Use **Right Clock Rate Multiplier** for polyrhythms.
- Route LFOs 5–6 to external CV outputs as slow envelopes; use **Polarity → Bipolar** for ±5V style modulation.

---

## Working with the OLED page renderer
The v2.0 tools reuse the firmware’s drawing code to render the 128×32 OLED pages to files. It is not a live emulator; instead, it produces accurate PNG captures you can drop into tutorials or share while you iterate on presets.

1. **Run the renderer.** From the repo root: `python tools/oled_renderer/render_pages.py`. It parses the official font tables and writes PNGs to `docs/oled-pages/` plus metadata for the web viewer.
2. **Tweak page states.** Edit `tools/oled_renderer/page_states.json` to change labels, values, or activity indicators, then rerun the script to regenerate captures.
3. **Preview interactively.** Serve `tools/oled_renderer` (e.g., `python -m http.server 8000` in that folder) and open `http://localhost:8000/web/` to live-edit the JSON and export PNGs without touching the hardware.
4. **Use captures in docs.** The generated files mirror the hardware display exactly, so you can embed them in manuals, READMEs, or share them with collaborators.

### OLED page gallery
These captures show the factory-default layouts so you can follow along with the manual or annotate parameter walkthroughs. Each image is pulled directly from `docs/oled-pages/` generated by the renderer above.

| Page | Preview |
|------|---------|
| DSP Edit | ![DSP Edit page](docs/oled-pages/dsp-edit.png) |
| LFO Edit | ![LFO Edit page](docs/oled-pages/lfo-edit.png) |
| Options | ![Options page](docs/oled-pages/options.png) |
| Presets | ![Presets page](docs/oled-pages/presets.png) |
| MIDI | ![MIDI page](docs/oled-pages/midi.png) |
| Debug | ![Debug page](docs/oled-pages/debug.png) |
| Clock Debug | ![Clock Debug page](docs/oled-pages/clock-debug.png) |

---

## Interface map
### Hardware controls
- **8 Knobs:** Meta1, Meta2, LFO Rate, Time L, Time R, Cutoff, Feedback, Mix
- **2 Encoders:** Left (navigation), Right (parameter editing)
- **2 CV Inputs:** LFO Adjust, Delay Adjust (with dedicated knobs)
- **2 Gate Inputs:** Sync/Trigger (Gate 1), Freeze/Reset (Gate 2)
- **Audio I/O:** Stereo input/output
- **6 CV Outputs:** 4 from LFOs 1–4, 2 from LFOs 5–6
- **2 Gate Outputs:** Phase-locked clock outputs
- **MIDI:** Full MIDI I/O with clock sync

### Navigation cheatsheet
- **Left encoder (turn):** Move between pages (`LFO EDIT → OPTIONS → DSP EDIT → PRESETS → MIDI → DEBUG`).
- **Left encoder (click):** Context jumps (LFO selection vs. parameter edit, quick hop to DSP/Debug, or factory reset on the Debug page).
- **Left encoder (hold + turn):** Scroll pages while held.
- **Right encoder (click):** Toggle edit mode for the highlighted field.
- **Right encoder (hold):** Enter modulation editing; **hold + turn** to tweak while mod routing is active.
- **Both encoders held:** Save current settings.
- **Right encoder hold + Freeze:** Reset oscillators and system state.

---

## Signal flow at a glance
```
Input → Delay Processing → Filter → Output
  ↑           ↑              ↑
  └─ LFO Modulation ────────┘
  └─ Clock/Sync System
  └─ MIDI/CV Control
```

- The **delay engine** hosts the selected algorithm, optional distortion, and filtering.
- **Six LFOs** provide modulation with cross-mod, FM/AM, and envelope-style behaviors.
- The **clock system** can run internally or follow external CV/MIDI, feeding both the DSP and clock outputs.
- **CV/MIDI inputs** map to modulation targets for hands-on performance.

---

<<<<<<< Updated upstream
## Performance tips
- Use **LFO Rate Multiplier** as a global “tempo nudge” without touching individual LFOs.
- Keep **Enable Debug Info** on while learning; the extra pages show what the system is actually doing.
- Store **Global Presets** for whole-rig states and **DSP/LFO Presets** when you only want to recall a subsection of the patch.
=======
## Factory Reset

If Kali loads corrupted settings or appears to behave incorrectly on startup, you can perform a factory reset to restore all default settings.

### How to Factory Reset

1. **Power off** Kali completely
2. **Hold down both Gate Input buttons** (Gate In 1 and Gate In 2)
3. **Power on** Kali while continuing to hold both buttons
4. The screen will display **"FACTORY RESET"** and **"Loading defaults..."**
5. **Release the buttons** after seeing the message
6. Kali will start with clean factory defaults, bypassing any saved presets or corrupted settings

### What Gets Reset

- All global options return to factory defaults
- All LFO settings return to initial values
- DSP parameters reset to defaults
- Clock and sync settings reset
- Saved preset selection is cleared

### What Is Preserved

- Your saved presets remain in memory (can be manually loaded later if needed)
- Hardware calibration settings are maintained

**Note:** Factory reset is especially useful if:
- Kali won't start properly
- Settings appear corrupted or cause unexpected behavior
- You want a fresh start without manually resetting each parameter
- A preset causes crashes or instability

---

## Complete Options Reference
>>>>>>> Stashed changes

---

## Reference Library
The following tables collect every adjustable option. Ranges refer to on-screen values.

### Global options
| Option | Range | Default | Purpose |
|--------|-------|---------|---------|
| **LFO Rate Multiplier** | 1–255 | 24 | Global speed control for all LFOs; quick tempo shifts without editing each LFO. |
| **Left Clock PPQN** | 2–127 | 24 | PPQN for left clock output (4=quarters, 8=eighths, 16=sixteenths, 24=MIDI). |
| **Right Clock Rate Multiplier** | 1–16 | 1 | Clock division/multiplication for the right output relative to left. |
| **External CV Clock PPQN** | 1–127 | 1 | Pulses-per-quarter-note when syncing to external CV clock. |
| **Sync Mode** | 0–2 | 0 | Master clock source: 0=Internal, 1=External CV (Gate 1), 2=MIDI Clock. |
| **Sync Button Mode** | 0–1 | 0 | Gate 1 behavior: 0=Clock trigger input, 1=Reset all LFO phases. |
| **Freeze Button Mode** | 0–1 | 1 | Gate 2 behavior: 0=Freeze delay (stops writing, mutes wet), 1=System reset. |
| **Use Allpass** | 0–1 | 1 | Enables allpass filtering in the feedback path for smoother repeats. |
| **Reverb Wet Send** | 0–50 | 0 | Amount of delay output sent to reverb (reserved for future reverb). |
| **Reverb Dry Send** | 0–50 | 0 | Amount of dry input sent to reverb (reserved for future reverb). |
| **Reverb Feedback** | 50–99 | 85 | Reverb feedback amount (reserved for future reverb). |
| **Reverb Damp** | 1000–19000 Hz | 7500 | Reverb damping frequency (reserved for future reverb). |
| **Input Gain** | 0–255 | 215 | Input gain control; 215 ≈ 0 dB reference. |
| **Output Gain** | 0–255 | 255 | Output gain control; reduce if clipping. |
| **Input Width** | 0–1 | 1 | Stereo processing mode: 0=Sum to mono, 1=True stereo. |
| **Invert Encoders** | 0–1 | 0 | Reverses encoder direction. |
| **Enable Debug Info** | 0–1 | 1 | Shows debug pages and extra system information. |
| **Global Preset Load** | 0–32 | 0 | Load complete system state from preset slot. |
| **Global Preset Save** | 0–32 | 0 | Save current system state to preset slot. |

### DSP options
| Option | Range | Default | Purpose |
|--------|-------|---------|---------|
| **Mode** | 0–6 | 1 | Primary delay algorithm. |
| **Parameter 1–4** | 0–100 | 0 | Algorithm-specific controls. |
| **Distortion Algorithm** | 0–8 | 0 | Distortion type selection. |
| **Distortion Amount** | 0–99 | 0 | Distortion intensity. |
| **Distortion Target** | 0–3 | 0 | Where distortion is applied: Off/Dry/Wet/Both. |
| **Distortion Trim** | 0.0–1.0 | 1.0 | Post-distortion trim to control level. |
| **Filter** | 0–2 | 0 | Selects FIR/IIR/Off for additional filtering. |
| **Delay Range** | 0–4 | 1 | Delay time range preset. |
| **DSP Preset Load** | 0–32 | 0 | Load DSP configuration preset. |
| **DSP Preset Save** | 0–32 | 0 | Save current DSP configuration. |

### LFO options
| Option | Range | Default | Purpose |
|--------|-------|---------|---------|
| **Waveform** | 0–9 | 0 | Oscillator shape. |
| **LFO Mode** | 0–13 | 0 | LFO behavior; changes how sync and triggers are handled. |
| **Oneshot** | 0–1 | 0 | Single-cycle mode per trigger. |
| **Multiply L Time** | 1–100 | 1 | Primary frequency multiplier relative to left delay. |
| **Divide Numerator** | 1–1000 | 1 | Frequency divider/multiplier. |
| **Polarity** | 0–3 | 1 | Output range: 0=Unipolar+, 1=Bipolar, 2=Unipolar-, 3=Inverted bipolar. |
| **Adjust** | 0.0–1.0 | 0.0 | Multi-function control; meaning depends on LFO mode. |
| **Offset** | -2048 to +2048 | 0 | DC offset before scaling. |
| **Attenuate** | 1–100% | 100 | Output amplitude scaling. |
| **Phase Offset** | 0–360° | 0 | Phase relationship to other LFOs. |
| **Trigger/Reset** | 0–2 | 0 | External trigger source: 0=None, 1=Gate 1, 2=Gate 2. |
| **Offset Cal** | -2048 to +2047 | 0 | Hardware calibration offset for CV outputs. |
| **Attenuate Cal** | 1–100% | 100 | Hardware calibration scaling for CV outputs. |
| **ADSR Attack** | 0.0–10.0s | 0.0 | Envelope attack time (Envelope mode). |
| **ADSR Decay** | 0.0–10.0s | 0.0 | Envelope decay time (Envelope mode). |
| **ADSR Sustain** | 0.0–1.0 | 0.5 | Envelope sustain level (Envelope mode). |
| **ADSR Release** | 0.0–10.0s | 0.2 | Envelope release time (Envelope mode). |
| **EOC Action** | 0–7 | 0 | Behavior when the LFO completes one cycle. |
| **EOC Target** | 0–10 | 0 | Which LFO receives end-of-cycle action. |
| **FM Source** | 0–10 | 0 | Which LFO provides frequency modulation. |
| **FM Amount** | -100% to +100% | 0 | Frequency modulation depth. |
| **AM Source** | 0–10 | 0 | Which LFO provides amplitude modulation. |
| **AM Amount** | -100% to +100% | 0 | Amplitude modulation depth. |
| **LFO Preset Load** | 0–32 | 0 | Load LFO configuration from preset. |
| **LFO Preset Save** | 0–32 | 0 | Save current LFO configuration. |

### Why these options exist
- **Hardware compatibility:** Encoder inversion and calibration settings account for hardware differences and tolerances.
- **Performance control:** Preset systems, quick-adjust knobs, and CV inputs keep live tweaks immediate.
- **Integration flexibility:** Multiple sync modes, PPQN settings, and polarity options let Kali sit in MIDI, modular, or pedalboard rigs.
- **Creative depth:** Cross-modulation, multiple LFO behaviors, and algorithm parameters unlock evolving textures without menu diving.
- **Future expansion:** Reserved reverb parameters and range presets leave room for updates without hardware changes.

---

## Troubleshooting
- If the display feels unresponsive, toggle **Enable Debug Info** to confirm the system is running and check clock status.
- Clock issues? Verify **Sync Mode** matches your source and that PPQN values align between devices.
- Unexpected levels? Revisit **Input/Output Gain** and **Distortion Trim** before adjusting downstream gear.

